# 连接顺序测试指南

## 测试目标
验证先启动发送端再启动接收端时，接收端能够正常接收到发送端的屏幕画面。

## 测试步骤

### 1. 启动信令服务器
```bash
cd signaling_server
node server.js
```

### 2. 启动发送端
1. 在Android设备上启动应用
2. 选择"发送端"模式
3. 输入服务器地址（例如：192.168.168.102:6060）
4. 点击"开始投屏"
5. 授予屏幕录制权限
6. 确认发送端已成功连接并开始共享屏幕

### 3. 启动接收端
1. 在另一个Android设备上启动应用
2. 选择"接收端"模式
3. 应用会自动连接到相同的服务器地址
4. 观察是否能够接收到发送端的屏幕画面

## 预期结果

### 成功情况
- 接收端连接后立即能够看到发送端的屏幕画面
- 画面流畅，延迟较低
- 连接状态稳定

### 失败情况
- 接收端连接后无法看到画面
- 连接频繁断开重连
- 画面卡顿或延迟过高

## 故障排除

### 如果接收端无法接收画面
1. 检查网络连接是否正常
2. 确认服务器地址是否正确
3. 查看日志输出，确认WebSocket连接状态
4. 检查防火墙设置

### 如果画面卡顿
1. 检查网络带宽是否足够
2. 确认设备性能是否满足要求
3. 调整视频质量参数

## 日志检查

### 发送端日志
- 查找"WebSocket连接已建立"
- 查找"Offer已发送"
- 查找"ICE连接状态: CONNECTED"

### 接收端日志
- 查找"已连接到信令服务器"
- 查找"收到offer，开始处理"
- 查找"Answer已发送"
- 查找"视频流已接收"

### 服务器日志
- 查找"检测到待处理的offer，发送给新连接的客户端"
- 查找"标记客户端为发送者，offer已保存"
- 查找"标记客户端为接收者"

## 技术实现要点

### 信令服务器改进
- 添加了offer缓存机制
- 当接收端连接时自动发送已存在的offer
- 改进了客户端角色管理

### 接收端改进
- 添加了重连机制
- 改进了错误处理
- 增强了连接状态监控

### 发送端改进
- 保持了原有的稳定性
- 确保offer能够被正确缓存 