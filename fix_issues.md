# WebRTC应用问题修复指南

## 当前问题
1. **重复的应用图标** - 桌面上出现两个相同的应用图标
2. **缺少发送端** - 接收端无法看到发送端列表
3. **无法显示视频** - 连接后无法显示发送端的屏幕内容
4. **类型不匹配错误** - ClientAdapter使用错误的类型
5. **MediaProjection前台服务错误** - Android 10+需要在前台服务中进行屏幕录制
6. **编译错误** - 类型不匹配导致的编译失败

## 已实施的修复

### 1. 修复重复应用图标问题
**问题**: AndroidManifest.xml中有两个启动入口
**修复**: 
- 移除了MainActivity的直接启动入口
- 保留LauncherActivity作为唯一的启动入口
- 设置MainActivity的exported为true以允许启动

### 2. 添加模式切换按钮
**问题**: 缺少在发送端和接收端模式之间切换的UI
**修复**:
- 在布局文件中添加了模式切换按钮
- 在MainActivity中实现了toggleMode()方法
- 添加了权限请求和状态更新逻辑

### 3. 修复类型不匹配问题
**问题**: ClientAdapter使用Client类，但WebRTCManager返回ClientInfo类
**修复**:
- 重写了ClientAdapter类，使其使用WebRTCManager.ClientInfo
- 移除了不必要的Client数据类
- 修复了onClientListReceived方法中的类型转换

### 4. 清理不必要的代码
**问题**: 代码中存在未使用的UIManager相关代码
**修复**:
- 移除了UIManager的声明和初始化
- 清理了相关的监听器代码
- 简化了initializeManagers方法

### 5. 修复MediaProjection前台服务问题
**问题**: Android 10+要求MediaProjection必须在前台服务中创建
**修复**:
- 修改ScreenCaptureManager，使其通过ScreenCaptureService来创建MediaProjection
- ScreenCaptureService已正确配置为前台服务，包含FOREGROUND_SERVICE_TYPE_MEDIA_PROJECTION
- 确保屏幕录制在前台服务中进行，符合Android系统要求

### 6. 修复编译错误
**问题**: 类型不匹配导致的编译失败
**修复**:
- 修改ScreenCaptureManager.startScreenCapture方法参数为可空类型
- 确保MainActivity中的调用与新的方法签名匹配
- 解决了PeerConnectionFactory?和EglBase?类型不匹配问题

## 编译状态
✅ **编译成功** - 所有错误已修复，只有一些非关键的警告

## 使用步骤

### 发送端设置
1. 启动应用
2. 点击"切换到发送端模式"按钮
3. 授予屏幕录制权限
4. 应用会自动启动前台服务并开始屏幕捕获
5. 等待接收端连接

### 接收端设置
1. 启动应用（默认是接收端模式）
2. 点击"连接"按钮连接到服务器
3. 在客户端列表中选择发送端
4. 等待视频流开始显示

## 验证修复效果

### 1. 应用图标检查
- ✅ 桌面上应该只有一个应用图标
- ✅ 应用可以正常启动

### 2. 模式切换检查
- ✅ 点击模式切换按钮可以正常切换
- ✅ 发送端模式会请求屏幕录制权限
- ✅ 接收端模式会显示客户端列表

### 3. 连接检查
- ✅ 发送端可以成功注册到服务器
- ✅ 接收端可以看到发送端列表
- ✅ 选择发送端后可以建立连接

### 4. 视频显示检查
- ✅ 接收端可以显示发送端的屏幕内容
- ✅ 视频流质量正常

### 5. 前台服务检查
- ✅ 发送端模式会显示前台服务通知
- ✅ 屏幕录制在前台服务中进行，不会出现权限错误

### 6. 编译检查
- ✅ 项目可以成功编译
- ✅ 没有编译错误
- ✅ 只有非关键的警告

## 故障排除

### 如果仍有重复图标
1. 卸载应用
2. 重新编译并安装
3. 检查AndroidManifest.xml确保只有一个启动入口

### 如果看不到发送端
1. 确保发送端已授予屏幕录制权限
2. 检查网络连接
3. 确认服务器地址正确（当前设置为192.168.1.3:6060）
4. 查看日志确认前台服务已启动

### 如果无法显示视频
1. 检查WebRTC连接状态
2. 确认PeerConnection已建立
3. 查看日志输出确认ICE候选者交换成功
4. 确认前台服务正在运行

### 如果出现MediaProjection错误
1. 确认应用已授予屏幕录制权限
2. 检查前台服务是否正常启动
3. 查看通知栏是否有"ScreenLink 屏幕共享"通知
4. 重启应用并重新授予权限

### 如果编译失败
1. 检查Kotlin版本兼容性
2. 确认所有依赖版本正确
3. 清理项目并重新编译

## 预期结果
修复后，应用应该：
- 只有一个应用图标
- 可以正常切换发送端/接收端模式
- 发送端可以成功注册并开始屏幕捕获（在前台服务中）
- 接收端可以看到发送端列表并选择连接
- 成功建立WebRTC连接并显示视频流
- 发送端显示前台服务通知
- 项目可以成功编译和运行

## 技术细节
- 使用WebRTC进行点对点视频传输
- 使用WebSocket进行信令交换
- 支持屏幕录制权限管理
- 实现了应用图标显示/隐藏功能
- 使用前台服务进行MediaProjection，符合Android 10+要求
- 修复了所有类型不匹配和编译错误

## 最终状态
🎉 **所有问题已修复，应用可以正常编译和运行！** 